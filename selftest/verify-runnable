#!/bin/bash
#
# Very simple test to verify that the basic functionality works
#
# For this to work, you need to run both master and agent on your local
# host.
#

#DEBUG="--debug all"
CONFIG="--config etc/common.xml"
CLIENT="./testbus-client --config etc/common.xml $DEBUG"

function testbus_call {

	./testbus-client $CONFIG $DEBUG "$@"
}

function testbus_trace {

	echo "$@" >&2
}

function testbus_cleanup {

	if [ -n "$TESTBUS_TEMPDIR" ]; then
		rm -rf $TESTBUS_TEMPDIR
	fi

	if [ -n "$TESTBUS_TEST_HANDLE" ]; then
		testbus_call delete $TESTBUS_TEST_HANDLE
	fi
}

function testbus_init_test {

	myname=$1

	TESTCASE_NAME=`basename $myname| tr - _`

	trap testbus_cleanup 0 1 2
	set -e

	TESTBUS_TEMPDIR=`mktemp -d /tmp/testbusXXXXXX`

	testbus_call show-xml --raw > $TESTBUS_TEMPDIR/xml-tree-before

	TESTBUS_TEST_HANDLE=`testbus_call create-test $TESTCASE_NAME`
}

function testbus_claim_host {

	testbus_trace "claim host $*"
	testbus_call claim-host $TESTBUS_TEST_HANDLE "$@"
}

function testbus_run_command {

	testbus_trace "run command $*"
	testbus_call run-command --context $TESTBUS_TEST_HANDLE "$@"
}

testbus_init_test $0

TESTBUS_HOST=`testbus_claim_host`

# ch=`$CLIENT create-command /bin/true`
testbus_run_command --host $TESTBUS_HOST /bin/true

if testbus_run_command --host $TESTBUS_HOST /bin/false; then
	echo "client does not propagate remote command's exit status" >&2
	exit 1
fi

expect=$TESTBUS_TEMPDIR/expect
/usr/bin/wc < /etc/hosts > $expect

stdout=$TESTBUS_TEMPDIR/stdout
testbus_run_command --host $TESTBUS_HOST --send-stdin /usr/bin/wc < /etc/hosts >$stdout

diff=$TESTBUS_TEMPDIR/diff
if ! diff -bu $stdout $expect >$diff; then
	echo "Command output differs between local host and SUT"
	echo "---"
	cat $diff
	echo "---"
	exit 1
fi >&2

testbus_call show-xml --raw > $TESTBUS_TEMPDIR/xml-tree-after
if cmp -s $TESTBUS_TEMPDIR/xml-tree-before $TESTBUS_TEMPDIR/xml-tree-after; then
	echo "Testbus object tree not clean after test run"
	echo "Differences before/after"
	diff -u $TESTBUS_TEMPDIR/xml-tree-before $TESTBUS_TEMPDIR/xml-tree-after
	exit 1
fi >&2

echo "All tests completed successfully"
